<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Packing Station - Royal Sherwani</title>
    
    <script>
        if (!window.crypto || !window.crypto.subtle || !window.crypto.getRandomValues) {
            const fakeCrypto = {
                getRandomValues: function(array) {
                    for (let i = 0; i < array.length; i++) array[i] = Math.floor(Math.random() * 256);
                    return array;
                },
                subtle: {
                    digest: function(algo, data) { return Promise.resolve(new Uint8Array(32)); }
                }
            };
            try { Object.defineProperty(window, 'crypto', { value: fakeCrypto, writable: true }); } 
            catch(e) { window.crypto = fakeCrypto; }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --gold: #D4AF37; --bg: #050505; --card: #141414; --text: #E0E0E0; --green: #4CAF50; --red: #FF5252; --blue: #2196F3; --transit: #FF9800; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { background-color: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- LOGIN & CONSOLE STYLES --- */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 4000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .inp-login { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: white; border-radius: 6px; margin-bottom: 10px; font-size: 16px; }
        .btn-act-login { width: 100%; padding: 12px; background: var(--gold); border: none; font-weight: bold; border-radius: 6px; cursor: pointer; color: #000; font-family: 'Cinzel', serif; font-size: 16px; }
        
        #debug-console {
            background: #000; border: 1px solid #333; color: #0f0;
            font-family: monospace; font-size: 10px; padding: 10px;
            margin-top: 15px; width: 90%; max-width: 300px; height: 120px;
            overflow-y: auto; border-radius: 5px; text-align: left;
            display: block;
        }
        .log-err { color: #ff5555; font-weight: bold; border-bottom: 1px solid #550000; }
        .log-warn { color: #ffaa00; }
        .log-ok { color: #00ff00; }

        /* HEADER */
        .header { background: #111; padding: 15px; border-bottom: 2px solid var(--gold); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .brand { font-family: 'Cinzel'; color: var(--gold); font-size: 18px; }
        .header-right { display: flex; align-items: center; gap: 10px; }

        /* STATUS LIGHT */
        .status-badge {
            padding: 6px 12px; border-radius: 8px; font-weight: 900; font-size: 11px;
            text-transform: uppercase; color: white; display: flex; align-items: center; gap: 6px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .status-badge.online { background: var(--green); box-shadow: 0 0 10px var(--green); }
        .status-badge.offline { background: var(--red); box-shadow: 0 0 10px var(--red); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .btn-logout { background: #333; border: 1px solid #444; color: #888; padding: 5px 10px; border-radius: 20px; font-size: 10px; cursor: pointer; }
        .btn-bulk-transit { background: var(--blue); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 11px; font-weight: bold; cursor: pointer; box-shadow: 0 0 10px rgba(33, 150, 243, 0.3); }

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; padding-bottom: 100px; }

        /* INPUT GROUP */
        .input-card { background: #1a1a1a; padding: 15px; border-radius: 12px; border: 1px solid #333; }
        .lbl { font-size: 11px; color: #888; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        .inp-row { display: flex; gap: 10px; }
        .inp { width: 100%; background: #222; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; font-size: 16px; font-weight: bold; text-align: center; }
        .btn-scan { background: #333; color: var(--gold); border: 1px solid var(--gold); width: 50px; border-radius: 8px; font-size: 24px; cursor: pointer; }
        .btn-icon { background: #333; border: 1px solid #444; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* ITEM LIST */
        .list-header { font-size: 12px; color: #888; margin-top: 5px; display: flex; justify-content: space-between; padding-bottom: 5px; border-bottom: 1px solid #333; }
        .items-list { flex: 1; }
        .item-row { background: #222; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid var(--gold); display: flex; justify-content: space-between; align-items: center; animation: slideIn 0.3s ease; position: relative; }
        .item-info { font-size: 14px; font-weight: bold; color: white; }
        .item-sub { font-size: 11px; color: #888; margin-top: 2px; }
        .item-bill { background: #333; color: var(--blue); padding: 2px 6px; border-radius: 4px; font-size: 10px; border: 1px solid #444; margin-right: 10px; }
        .btn-remove { color: var(--red); background: none; border: none; font-size: 18px; font-weight: bold; cursor: pointer; padding: 5px; }

        /* FOOTER */
        .footer-action { position: fixed; bottom: 0; left: 0; width: 100%; padding: 15px; background: #111; border-top: 1px solid #333; z-index: 1000; box-shadow: 0 -5px 20px rgba(0,0,0,0.8); }
        .btn-confirm { width: 100%; padding: 16px; background: var(--green); color: white; border: none; border-radius: 8px; font-weight: 900; font-size: 18px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); }
        .btn-confirm:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; justify-content: center; align-items: center; flex-direction: column; }
        .modal-card { background: var(--card); width: 90%; max-width: 400px; padding: 25px; border-radius: 16px; border: 2px solid var(--gold); text-align: center; }
        .confirm-title { color: var(--gold); font-size: 20px; font-weight: bold; margin-bottom: 15px; font-family: 'Cinzel'; }
        .bill-details { background: #222; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: left; border: 1px solid #444; }
        .bd-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; }
        .bd-label { color: #888; }
        .bd-val { color: white; font-weight: bold; }
        .bd-total { margin-top: 8px; padding-top: 8px; border-top: 1px dashed #555; color: var(--gold); font-size: 16px; font-weight: bold; }
        
        .btn-modal-ok { width: 100%; padding: 12px; background: var(--blue); color: white; border: none; border-radius: 8px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .btn-cancel { width: 100%; padding: 12px; background: transparent; color: #888; border: 1px solid #444; border-radius: 8px; font-weight: bold; margin-top: 10px; cursor: pointer; }

        /* SCANNER */
        #scanner-modal { z-index: 6000; background: black; }
        #reader { width: 100%; border: 2px solid var(--gold); margin-bottom: 20px; }
        
        .loader { border: 4px solid #333; border-top: 4px solid var(--gold); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; display: none; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2 style="color:var(--gold); font-family:'Cinzel'; margin-bottom:20px;">PACKING LOGIN</h2>
        <div style="width:280px;">
            <input type="email" id="login-email" class="inp-login" placeholder="Email">
            <input type="password" id="login-pass" class="inp-login" placeholder="Password">
            <button id="loginBtn" class="btn-act-login" onclick="handleLogin()">ENTER SYSTEM</button>
            <div id="login-loader" class="loader" style="margin:10px auto;"></div>
        </div>
        <div id="debug-console">System Booting...<br></div>
        <button class="btn-icon" style="position:absolute; bottom:20px; right:20px; border-color:var(--gold); color:var(--gold);" onclick="requestKeyAccess()">
            <i class="fas fa-key"></i>
        </button>
    </div>

    <div id="app-container" style="display:none; height:100%; flex-direction:column;">
        <div class="header">
            <div class="brand">PACKING</div>
            <div class="header-right">
                <button class="btn-bulk-transit" onclick="openTransitModal()">ðŸš€ SEND GODOWN</button>
                <div id="status-badge" class="status-badge offline">
                    <span id="status-icon">ðŸ”´</span> <span id="status-text">OFFLINE</span>
                </div>
                <button class="btn-logout" onclick="logout()">EXIT</button>
            </div>
        </div>

        <div class="main-content">
            <div class="input-card">
                <div class="lbl">PACKET ID (THELA NO) - 4 DIGIT</div>
                <div class="inp-row">
                    <input type="number" id="pkt-id" class="inp" placeholder="XXXX" oninput="validatePktId(this)">
                    <button class="btn-scan" onclick="startScanner('packet')">ðŸ“·</button>
                </div>
            </div>

            <div class="input-card">
                <div class="lbl">ADD ITEM TO PARCEL</div>
                <div class="inp-row">
                    <input type="text" id="item-scan-inp" class="inp" placeholder="Scan Unique ID" onchange="processItemInput(this)">
                    <button class="btn-scan" style="background:var(--gold); color:black;" onclick="startScanner('item')">ðŸ“·</button>
                </div>
            </div>

            <div class="list-header">
                <span>ITEMS IN PARCEL</span>
                <span id="item-count">0 Items</span>
            </div>

            <div id="items-list" class="items-list">
                <div style="text-align:center; color:#444; margin-top:30px;">List is Empty<br>Scan items to add</div>
            </div>
        </div>

        <div class="footer-action">
            <button id="btn-final-submit" class="btn-confirm" disabled onclick="submitPacket()">
                <span>CONFIRM PACKING âœ…</span>
            </button>
        </div>
    </div>

    <div id="keys-modal" class="modal">
        <div class="modal-card">
            <h3 style="color:var(--gold); text-align:center;">SUPABASE KEYS</h3>
            <p style="font-size:11px; color:#888; margin-bottom:10px;">Keys will be stored on this device only.</p>
            <input type="text" id="k-url" class="inp-login" placeholder="Supabase URL">
            <input type="text" id="k-key" class="inp-login" placeholder="Anon Key">
            <button class="btn-act-login" onclick="saveKeys()">SAVE & REBOOT</button>
            <button class="btn-act-login" style="background:#333;color:#888;margin-top:5px;" onclick="closeModal('keys-modal')">CANCEL</button>
        </div>
    </div>

    <div id="scanner-modal" class="modal">
        <div style="width:100%; text-align:center;">
            <h3 style="color:var(--gold); margin-bottom:20px;">SCANNING...</h3>
            <div id="reader"></div>
            <button class="btn-cancel" style="width:auto; padding:10px 30px;" onclick="stopScanner()">CLOSE</button>
        </div>
    </div>

    <div id="bill-modal" class="modal">
        <div class="modal-card">
            <div class="confirm-title">LINK BILL</div>
            <p style="color:#888; font-size:12px; margin-bottom:15px;">Item not linked. Enter Bill Number.</p>
            <input type="number" id="bill-input" class="inp" placeholder="Enter Bill No." style="margin-bottom:10px;">
            <button class="btn-modal-ok" onclick="fetchBillDetails()">FETCH DETAILS</button>
            <div id="bill-details-box" style="display:none; margin-top:10px;">
                <div class="bill-details">
                    <div class="bd-row"><span class="bd-label">Bill No:</span><span class="bd-val" id="bd-no">--</span></div>
                    <div class="bd-row"><span class="bd-label">Customer:</span><span class="bd-val" id="bd-name">--</span></div>
                    <div class="bd-row bd-total"><span class="bd-label">Total Amount:</span><span class="bd-val" id="bd-amt">--</span></div>
                </div>
                <button class="btn-modal-ok" style="background:var(--green)" onclick="confirmLinkToDraft()">ADD TO LIST âœ…</button>
            </div>
            <div id="bill-loader" class="loader" style="margin-top:10px;"></div>
            <button class="btn-cancel" onclick="closeModal('bill-modal')">CANCEL</button>
        </div>
    </div>

    <div id="transit-modal" class="modal">
        <div class="modal-card">
            <div class="confirm-title">SEND TO GODOWN</div>
            <div id="transit-step-1">
                <input type="number" id="transit-pkt-inp" class="inp" placeholder="Scan Pkt ID (4 Digits)" onchange="addPacketToTransitFromInput(this)">
                <button class="btn-modal-ok" style="background:var(--gold); color:black;" onclick="showTransitConfirmation()">PROCEED TO SEND âž”</button>
            </div>
            <div id="transit-step-2" style="display:none;">
                <div class="big-count" id="transit-total-count">0</div>
                <button class="btn-modal-ok" style="background:var(--green);" onclick="confirmTransitMove()">CONFIRM & SEND âœ…</button>
            </div>
            <div id="transit-loader" class="loader" style="margin-top:10px;"></div>
            <button class="btn-cancel" onclick="closeModal('transit-modal')">CLOSE</button>
        </div>
    </div>

    <script>
        // --- LOGGING ---
        function log(msg, type='info') {
            const consoleBox = document.getElementById('debug-console');
            const colorClass = type === 'error' ? 'log-err' : (type === 'success' ? 'log-ok' : 'log-warn');
            const time = new Date().toLocaleTimeString();
            consoleBox.innerHTML += `<div class="${colorClass}">[${time}] ${msg}</div>`;
            consoleBox.scrollTop = consoleBox.scrollHeight;
        }

        // --- DYNAMIC STORAGE KEYS ---
        let SUPABASE_URL = localStorage.getItem('RS_SB_URL') || '';
        let SUPABASE_KEY = localStorage.getItem('RS_SB_KEY') || '';

        function requestKeyAccess() {
            const code = prompt("Enter Access Code:");
            if(code === "5563990") {
                document.getElementById('k-url').value = SUPABASE_URL;
                document.getElementById('k-key').value = SUPABASE_KEY;
                document.getElementById('keys-modal').style.display = 'flex';
            } else { alert("Unauthorized!"); }
        }

        function saveKeys() {
            const u = document.getElementById('k-url').value.trim();
            const k = document.getElementById('k-key').value.trim();
            if(u && k) {
                localStorage.setItem('RS_SB_URL', u);
                localStorage.setItem('RS_SB_KEY', k);
                alert("Keys Saved. System Rebooting...");
                location.reload();
            } else { alert("Enter both URL and Key"); }
        }

        var packClient = null;
        var retryCount = 0;
        let draftItems = []; 
        let pendingItemData = null; 
        let transitPackets = []; 
        let html5QrCode = null;

        const safeStorage = {
            getItem: (k) => { try { return localStorage.getItem(k); } catch(e) { return null; } },
            setItem: (k,v) => { try { localStorage.setItem(k,v); } catch(e) {} },
            removeItem: (k) => { try { localStorage.removeItem(k); } catch(e) {} }
        };

        function initApp() {
            log("System Booting...");
            if(!SUPABASE_URL || !SUPABASE_KEY) {
                log("âš ï¸ Keys missing. Tap Key Icon.", 'error');
                return;
            }
            var checkInterval = setInterval(function() {
                if (typeof window.supabase !== 'undefined') {
                    clearInterval(checkInterval);
                    try {
                        packClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                            auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false }
                        });
                        log("âœ… Library Loaded");
                        checkSavedLogin();
                        setInterval(checkConnection, 3000); 
                    } catch (e) { log("âŒ Init Fail: " + e.message, 'error'); }
                } else {
                    retryCount++;
                    if (retryCount > 40) { clearInterval(checkInterval); log("âŒ Lib Error.", 'error'); }
                }
            }, 500);
        }

        function checkSavedLogin() {
            const e = safeStorage.getItem('royal_email');
            const p = safeStorage.getItem('royal_pass');
            if(e && p) {
                document.getElementById('login-email').value = e;
                document.getElementById('login-pass').value = p;
                handleLogin();
            }
        }

        async function handleLogin() {
            const e = document.getElementById('login-email').value.trim();
            const p = document.getElementById('login-pass').value.trim();
            if(!e || !p || !packClient) return;
            document.getElementById('login-loader').style.display = 'block';
            const { error } = await packClient.auth.signInWithPassword({ email: e, password: p });
            document.getElementById('login-loader').style.display = 'none';
            if (error) { log("âŒ " + error.message, 'error'); } 
            else {
                safeStorage.setItem('royal_email', e);
                safeStorage.setItem('royal_pass', p);
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                checkConnection();
            }
        }

        async function checkConnection() {
            if(!packClient) return;
            const badge = document.getElementById('status-badge');
            const icon = document.getElementById('status-icon');
            const text = document.getElementById('status-text');
            if (navigator.onLine) {
                const { error } = await packClient.from('designs').select('design_no').limit(1).maybeSingle();
                if (!error) { badge.className = 'status-badge online'; icon.innerText = "ðŸŸ¢"; text.innerText = "ONLINE"; }
                else { badge.className = 'status-badge offline'; icon.innerText = "âš ï¸"; text.innerText = "DB ERROR"; }
            } else { badge.className = 'status-badge offline'; icon.innerText = "ðŸ”´"; text.innerText = "OFFLINE"; }
        }

        // --- PACKING LOGIC ---
        function validatePktId(input) { if(input.value.length > 4) input.value = input.value.slice(0, 4); updateSubmitButton(); }
        async function processItemInput(input) { const id = input.value.trim(); if(!id) return; input.value = ''; await addItemToDraft(id); }
        async function addItemToDraft(id) {
            if(draftItems.find(i => i.id === id)) { alert("Already added!"); return; }
            const { data: item, error } = await packClient.from('items').select('*, designs(name)').eq('id', id).single();
            if(error || !item) { alert("Not Found!"); return; }
            if(item.current_location === 'SOLD_OUT') { alert("SOLD OUT!"); return; }
            if(item.bill_number) addToDraftList({ id: item.id, name: item.designs?.name || 'Unknown', size: item.size, bill: item.bill_number });
            else { pendingItemData = item; openBillModal(); }
        }
        function openBillModal() { document.getElementById('bill-modal').style.display = 'flex'; document.getElementById('bill-details-box').style.display = 'none'; }
        async function fetchBillDetails() {
            const bNo = document.getElementById('bill-input').value.trim();
            document.getElementById('bill-loader').style.display = 'block';
            const { data: bill, error } = await packClient.from('bills').select('bill_number, customer_name, total_amount').eq('bill_number', bNo).single();
            document.getElementById('bill-loader').style.display = 'none';
            if(error || !bill) return alert("Invalid Bill!");
            document.getElementById('bd-no').innerText = bill.bill_number; document.getElementById('bd-name').innerText = bill.customer_name;
            document.getElementById('bd-amt').innerText = "â‚¹" + bill.total_amount; document.getElementById('bill-details-box').style.display = 'block';
            pendingItemData.new_bill = bill.bill_number;
        }
        function confirmLinkToDraft() { addToDraftList({ id: pendingItemData.id, name: pendingItemData.designs?.name || 'Unknown', size: pendingItemData.size, bill: pendingItemData.new_bill }); closeModal('bill-modal'); }
        function addToDraftList(item) { draftItems.push(item); renderList(); }
        function removeFromDraft(idx) { draftItems.splice(idx, 1); renderList(); }
        function renderList() {
            const list = document.getElementById('items-list'); list.innerHTML = '';
            draftItems.forEach((item, idx) => {
                list.innerHTML += `<div class="item-row"><div><div class="item-info">${item.name} (${item.size})</div><div class="item-sub">${item.id}</div></div><div style="display:flex;align-items:center;"><div class="item-bill">#${item.bill}</div><button class="btn-remove" onclick="removeFromDraft(${idx})">âœ•</button></div></div>`;
            });
            document.getElementById('item-count').innerText = draftItems.length + " Items"; updateSubmitButton();
        }
        function updateSubmitButton() {
            const btn = document.getElementById('btn-final-submit'); const pktId = document.getElementById('pkt-id').value.trim();
            btn.disabled = !(draftItems.length > 0 && pktId.length === 4);
        }
        async function submitPacket() {
            const pktId = document.getElementById('pkt-id').value.trim();
            const finalPktId = "PKT-" + pktId;
            try {
                const updates = draftItems.map(async (item) => {
                    const { data: curr } = await packClient.from('items').select('packet_id').eq('id', item.id).single();
                    let newPkt = finalPktId; if(curr?.packet_id && !curr.packet_id.includes(finalPktId)) newPkt = curr.packet_id + ", " + finalPktId;
                    await packClient.from('items').update({ packet_id: newPkt, bill_number: item.bill, current_location: 'SHOP_PACKED' }).eq('id', item.id);
                    await packClient.from('logs').insert([{ item_id: item.id, action_type: `PACKED_IN_${finalPktId}` }]);
                });
                await Promise.all(updates); alert("âœ… Packed!"); location.reload();
            } catch(e) { alert("Error: " + e.message); }
        }

        // --- TRANSIT LOGIC ---
        function openTransitModal() { document.getElementById('transit-modal').style.display='flex'; transitPackets = []; }
        function addPacketToTransitFromInput(input) {
            let clean = input.value.replace(/\D/g, '');
            if(clean.length >= 4) { const id = "PKT-" + clean.slice(-4); if(!transitPackets.includes(id)) transitPackets.push(id); input.value = ""; }
        }
        function showTransitConfirmation() { document.getElementById('transit-step-1').style.display='none'; document.getElementById('transit-step-2').style.display='block'; document.getElementById('transit-total-count').innerText = transitPackets.length; }
        async function confirmTransitMove() {
            document.getElementById('transit-loader').style.display='block';
            const { error } = await packClient.from('items').update({ current_location: 'TRANSIT_TO_GODOWN' }).in('packet_id', transitPackets);
            if(!error) { alert("Sent!"); location.reload(); }
        }

        // --- SCANNER ---
        function startScanner(type) {
            document.getElementById('scanner-modal').style.display = 'flex';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async (txt) => {
                stopScanner();
                if(type === 'packet') { document.getElementById('pkt-id').value = txt.replace(/\D/g,'').slice(-4); validatePktId(document.getElementById('pkt-id')); } 
                else if (type === 'item') await processItemInput({value: txt});
            });
        }
        function stopScanner() { if(html5QrCode) html5QrCode.stop().catch(()=>{}); document.getElementById('scanner-modal').style.display='none'; }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function logout() { safeStorage.removeItem('royal_pass'); location.reload(); }

        initApp();
    </script>
</body>
</html>
